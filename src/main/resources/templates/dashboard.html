<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Stream Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .recent-events {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .event-item:last-child {
            border-bottom: none;
        }
        
        .event-type {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .event-user {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
        }
        
        .event-time {
            font-size: 0.8rem;
            color: #999;
        }
        
        .top-users {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-id {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .user-events {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .system-health {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .health-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .health-status {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .health-status.healthy {
            color: #28a745;
        }
        
        .health-status.error {
            color: #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .last-updated {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .updating {
            animation: pulse 1s infinite;
        }
        
        /* Pipeline Visualization Styles */
        .pipeline-card {
            grid-column: span 2;
        }
        
        .pipeline-container {
            position: relative;
            height: 200px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .pipeline-svg {
            width: 100%;
            height: 100%;
        }
        
        .pipeline-stage {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pipeline-stage:hover {
            transform: scale(1.05);
        }
        
        .stage-box {
            fill: #667eea;
            stroke: #fff;
            stroke-width: 2;
            rx: 8;
        }
        
        .stage-box.healthy {
            fill: #28a745;
        }
        
        .stage-box.warning {
            fill: #ffc107;
        }
        
        .stage-box.error {
            fill: #dc3545;
        }
        
        .stage-text {
            fill: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        
        .stage-count {
            fill: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        
        .pipeline-arrow {
            fill: none;
            stroke: #667eea;
            stroke-width: 3;
            marker-end: url(#arrowhead);
        }
        
        .pipeline-arrow.active {
            stroke: #28a745;
            animation: flowAnimation 2s infinite;
        }
        
        .event-particle {
            fill: #ffc107;
            r: 4;
            opacity: 0;
        }
        
        .event-particle.flowing {
            animation: particleFlow 3s infinite;
        }
        
        .pipeline-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .pipeline-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .pipeline-stat.success {
            border-left-color: #28a745;
        }
        
        .pipeline-stat.warning {
            border-left-color: #ffc107;
        }
        
        .pipeline-stat.error {
            border-left-color: #dc3545;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .error-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        @keyframes flowAnimation {
            0% { stroke-dasharray: 0 10; }
            50% { stroke-dasharray: 5 5; }
            100% { stroke-dasharray: 10 0; }
        }
        
        @keyframes particleFlow {
            0% { 
                opacity: 1;
                transform: translateX(0);
            }
            50% {
                opacity: 0.8;
            }
            100% { 
                opacity: 0;
                transform: translateX(200px);
            }
        }
        
        .pipeline-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Dashboard Links Styles */
        .dashboard-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .link-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
        }
        
        .link-section h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
        }
        
        .dashboard-link {
            display: block;
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .dashboard-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-link:active {
            transform: translateY(0);
        }
        
        /* Cluster Information Styles */
        .cluster-info-card {
            display: none; /* Hidden by default, shown when cluster data is available */
        }
        
        .cluster-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .cluster-metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .cluster-metric.leader {
            border-left-color: #28a745;
        }
        
        .cluster-metric.member {
            border-left-color: #17a2b8;
        }
        
        .cluster-metric.status {
            border-left-color: #ffc107;
        }
        
        .cluster-metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .cluster-metric-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .cluster-members {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .cluster-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .cluster-member.leader {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .cluster-member.self {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        
        .cluster-member-address {
            font-family: monospace;
            font-size: 0.9rem;
            color: #333;
        }
        
        .cluster-member-roles {
            display: flex;
            gap: 5px;
        }
        
        .cluster-role {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .cluster-role.leader {
            background: #28a745;
        }
        
        .cluster-navigation {
            margin-top: 15px;
            text-align: center;
        }
        
        .cluster-dashboard-link {
            display: inline-block;
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .cluster-dashboard-link:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .dashboard-links {
                flex-direction: column;
                align-items: center;
            }
            
            .link-section {
                width: 100%;
                max-width: 300px;
            }
            
            .cluster-overview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üöÄ Event Stream Dashboard</h1>
            <div class="subtitle">Real-time Kafka + Pekko + H2 Analytics</div>
            <div class="dashboard-links">
                <div class="link-section">
                    <h4>üìä Dashboard Views</h4>
                    <a href="/dashboard" class="dashboard-link">Main Dashboard</a>
                    <a href="/cluster/dashboard" class="dashboard-link" target="_blank">üåê Cluster Dashboard</a>
                    <a href="/dashboard/data" class="dashboard-link" target="_blank">Dashboard Data (JSON)</a>
                    <a href="/dashboard/metrics" class="dashboard-link" target="_blank">Real-time Metrics (JSON)</a>
                </div>
                <div class="link-section">
                    <h4>‚ö° Performance APIs</h4>
                    <a href="/dashboard/performance" class="dashboard-link" target="_blank">Performance Metrics</a>
                    <a href="/dashboard/performance/realtime" class="dashboard-link" target="_blank">Real-time Performance</a>
                </div>
                <div class="link-section">
                    <h4>üîÑ Pipeline APIs</h4>
                    <a href="/dashboard/pipeline/status" class="dashboard-link" target="_blank">Pipeline Status</a>
                    <a href="/dashboard/pipeline/flow" class="dashboard-link" target="_blank">Pipeline Flow Metrics</a>
                    <a href="/dashboard/pipeline/errors" class="dashboard-link" target="_blank">Pipeline Errors</a>
                </div>
            </div>
        </div>
        
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="status-value" id="totalEvents">-</span>
                <span class="status-label">Total Events</span>
            </div>
            <div class="status-item">
                <span class="status-value" id="totalUsers">-</span>
                <span class="status-label">Active Users</span>
            </div>
            <div class="status-item">
                <span class="status-value" id="averageEvents">-</span>
                <span class="status-label">Avg Events/User</span>
            </div>
            <div class="status-item">
                <span class="status-value" id="systemStatus">üü¢</span>
                <span class="status-label">System Status</span>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>üìä Event Types Distribution</h3>
                <div class="chart-container">
                    <canvas id="eventTypesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Events Over Time</h3>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>üî• Recent Events</h3>
                <div class="recent-events" id="recentEvents">
                    <div class="loading">Loading recent events...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üë• Top Users</h3>
                <div class="top-users" id="topUsers">
                    <div class="loading">Loading top users...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üíö System Health</h3>
                <div class="system-health" id="systemHealth">
                    <div class="loading">Loading system health...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìã User Activity Stats</h3>
                <div id="userActivityStats">
                    <div class="loading">Loading user activity...</div>
                </div>
            </div>
            
            <div class="card cluster-info-card" id="clusterInfoCard">
                <h3>üåê Cluster Information</h3>
                <div id="clusterInfo">
                    <div class="loading">Loading cluster information...</div>
                </div>
            </div>
            
            <div class="card pipeline-card">
                <h3>üîÑ Event Pipeline Flow</h3>
                <div class="pipeline-container" id="pipelineContainer">
                    <div class="loading">Loading pipeline visualization...</div>
                </div>
                <div class="pipeline-stats" id="pipelineStats">
                    <div class="loading">Loading pipeline stats...</div>
                </div>
            </div>
        </div>
        
        <div class="last-updated" id="lastUpdated">
            Last updated: Never
        </div>
    </div>

    <script>
        let eventTypesChart, timeChart;
        let updateInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            
            // Auto-refresh every 5 seconds
            updateInterval = setInterval(loadDashboardData, 5000);
        });
        
        function initializeCharts() {
            // Event Types Pie Chart
            const eventTypesCtx = document.getElementById('eventTypesChart').getContext('2d');
            eventTypesChart = new Chart(eventTypesCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Time Series Chart
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Events',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Users',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                document.getElementById('statusBar').classList.add('updating');
                
                const response = await fetch('/dashboard/data');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data loaded:', data);
                
                if (data.error) {
                    console.error('Dashboard error:', data.error);
                    return;
                }
                
                console.log('Updating overview with:', data.overview);
                updateOverview(data.overview);
                updateEventTypesChart(data.eventTypes);
                updateTimeChart(data.timeAnalytics);
                updateRecentEvents(data.recentEvents);
                updateTopUsers(data.topUsers);
                updateSystemHealth(data.systemHealth);
                updateUserActivityStats(data.userActivity, data.overview);
                updatePipelineVisualization(data.performance);
                
                // Add cluster info if available
                if (data.clusterInfo) {
                    updateClusterInfo(data.clusterInfo);
                    document.getElementById('clusterInfoCard').style.display = 'block';
                } else {
                    document.getElementById('clusterInfoCard').style.display = 'none';
                }
                
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date(data.lastUpdated).toLocaleTimeString()}`;
                
                console.log('Dashboard update completed successfully');
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                // Show error in the UI
                document.getElementById('totalEvents').textContent = 'Error';
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('averageEvents').textContent = 'Error';
            } finally {
                document.getElementById('statusBar').classList.remove('updating');
            }
        }
        
        function updateOverview(overview) {
            console.log('updateOverview called with:', overview);
            if (!overview) {
                console.warn('No overview data provided');
                return;
            }
            
            const totalEventsEl = document.getElementById('totalEvents');
            const totalUsersEl = document.getElementById('totalUsers');
            const averageEventsEl = document.getElementById('averageEvents');
            
            console.log('Elements found:', {
                totalEvents: !!totalEventsEl,
                totalUsers: !!totalUsersEl,
                averageEvents: !!averageEventsEl
            });
            
            if (totalEventsEl) {
                totalEventsEl.textContent = overview.totalEvents?.toLocaleString() || '0';
                console.log('Updated totalEvents to:', totalEventsEl.textContent);
            }
            
            if (totalUsersEl) {
                totalUsersEl.textContent = overview.totalUsers?.toLocaleString() || '0';
                console.log('Updated totalUsers to:', totalUsersEl.textContent);
            }
            
            if (averageEventsEl) {
                averageEventsEl.textContent = Math.round((overview.averageEventsPerUser || 0) * 10) / 10;
                console.log('Updated averageEvents to:', averageEventsEl.textContent);
            }
        }
        
        function updateEventTypesChart(eventTypes) {
            if (!eventTypes || !eventTypes.chartData) return;
            
            const labels = eventTypes.chartData.map(item => item.name);
            const data = eventTypes.chartData.map(item => item.value);
            
            eventTypesChart.data.labels = labels;
            eventTypesChart.data.datasets[0].data = data;
            eventTypesChart.update('none');
        }
        
        function updateTimeChart(timeAnalytics) {
            if (!timeAnalytics || !timeAnalytics.hourlyData) return;
            
            const labels = timeAnalytics.hourlyData.map(item => item.hour);
            const eventsData = timeAnalytics.hourlyData.map(item => item.events);
            const usersData = timeAnalytics.hourlyData.map(item => item.users);
            
            timeChart.data.labels = labels;
            timeChart.data.datasets[0].data = eventsData;
            timeChart.data.datasets[1].data = usersData;
            timeChart.update('none');
        }
        
        function updateRecentEvents(recentEvents) {
            if (!recentEvents) return;
            
            const container = document.getElementById('recentEvents');
            
            if (recentEvents.length === 0) {
                container.innerHTML = '<div class="loading">No recent events</div>';
                return;
            }
            
            container.innerHTML = recentEvents.map(event => `
                <div class="event-item" title="${event.fullUserId || event.userId}">
                    <div>
                        <span class="event-type">${event.eventType}</span>
                        <div class="event-user">${event.userId}</div>
                        <div class="event-details" style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                            ${event.details || 'Event processed'}
                        </div>
                    </div>
                    <div class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
        }
        
        function updateTopUsers(topUsers) {
            if (!topUsers) return;
            
            const container = document.getElementById('topUsers');
            
            if (topUsers.length === 0) {
                container.innerHTML = '<div class="loading">No users found</div>';
                return;
            }
            
            container.innerHTML = topUsers.map((user, index) => `
                <div class="user-item">
                    <div>
                        <div style="font-weight: bold;">#${index + 1}</div>
                        <div class="user-id">${user.userId}</div>
                    </div>
                    <span class="user-events">${user.eventCount}</span>
                </div>
            `).join('');
        }
        
        function updateSystemHealth(systemHealth) {
            if (!systemHealth) return;
            
            const container = document.getElementById('systemHealth');
            
            container.innerHTML = `
                <div class="health-item">
                    <div class="health-status ${systemHealth.database?.status === 'healthy' ? 'healthy' : 'error'}">
                        ${systemHealth.database?.status === 'healthy' ? '‚úÖ' : '‚ùå'}
                    </div>
                    <div>Database</div>
                </div>
                <div class="health-item">
                    <div class="health-status healthy">
                        ${Math.round(systemHealth.memory?.percentage || 0)}%
                    </div>
                    <div>Memory</div>
                </div>
                <div class="health-item">
                    <div class="health-status ${systemHealth.overall?.status === 'healthy' ? 'healthy' : 'error'}">
                        ${systemHealth.overall?.status === 'healthy' ? 'üü¢' : 'üî¥'}
                    </div>
                    <div>Overall</div>
                </div>
            `;
            
            // Update system status in header
            document.getElementById('systemStatus').textContent = 
                systemHealth.overall?.status === 'healthy' ? 'üü¢' : 'üî¥';
        }
        
        function updateUserActivityStats(userActivity, overview) {
            // Use overview data if userActivity is not available (MySQL profile)
            const dataSource = (userActivity && userActivity.totalUsers > 0) ? userActivity : overview;
            if (!dataSource) return;
            
            const container = document.getElementById('userActivityStats');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
                            ${dataSource.totalUsers || 0}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">Total Users</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">
                            ${dataSource.totalUsers || 0}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">Active Users</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">
                            ${dataSource.averageEventsPerUser ? dataSource.averageEventsPerUser.toFixed(1) : 0}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">Avg Events/User</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">
                            ${dataSource.totalEvents || 0}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">Max Events/User</div>
                    </div>
                </div>
            `;
        }
        
        function updateClusterInfo(clusterInfo) {
            if (!clusterInfo) return;
            
            const container = document.getElementById('clusterInfo');
            
            // Build cluster overview metrics
            const overviewHtml = `
                <div class="cluster-overview">
                    <div class="cluster-metric member">
                        <div class="cluster-metric-value">${clusterInfo.memberCount || 0}</div>
                        <div class="cluster-metric-label">Cluster Nodes</div>
                    </div>
                    <div class="cluster-metric ${clusterInfo.isLeader ? 'leader' : 'member'}">
                        <div class="cluster-metric-value">${clusterInfo.isLeader ? 'üëë Leader' : 'üë• Member'}</div>
                        <div class="cluster-metric-label">Node Role</div>
                    </div>
                    <div class="cluster-metric status">
                        <div class="cluster-metric-value">${clusterInfo.clusterStatus || 'Unknown'}</div>
                        <div class="cluster-metric-label">Cluster Status</div>
                    </div>
                </div>
            `;
            
            // Build cluster members list if available
            let membersHtml = '';
            if (clusterInfo.members && clusterInfo.members.length > 0) {
                membersHtml = `
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; color: #333; font-size: 1rem;">Cluster Members</h4>
                        <div class="cluster-members">
                            ${clusterInfo.members.map(member => `
                                <div class="cluster-member ${member.isLeader ? 'leader' : ''} ${member.address === clusterInfo.selfAddress ? 'self' : ''}">
                                    <div>
                                        <div class="cluster-member-address">${member.address}</div>
                                        <div class="cluster-member-roles">
                                            ${member.roles ? member.roles.map(role => 
                                                `<span class="cluster-role ${member.isLeader ? 'leader' : ''}">${role}</span>`
                                            ).join('') : ''}
                                        </div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666;">
                                        ${member.isLeader ? 'üëë' : ''}
                                        ${member.address === clusterInfo.selfAddress ? '(This Node)' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Build navigation section
            const navigationHtml = `
                <div class="cluster-navigation">
                    <a href="/cluster/dashboard" class="cluster-dashboard-link" target="_blank">
                        üîó Detailed Cluster Dashboard
                    </a>
                </div>
            `;
            
            // Combine all sections
            container.innerHTML = overviewHtml + membersHtml + navigationHtml;
        }
        
        function updatePipelineVisualization(performanceData) {
            // Load pipeline status from the new endpoint
            loadPipelineStatus();
        }
        
        async function loadPipelineStatus() {
            try {
                const response = await fetch('/dashboard/pipeline/status');
                const pipelineData = await response.json();
                
                if (pipelineData.error) {
                    console.error('Pipeline error:', pipelineData.error);
                    return;
                }
                
                renderPipelineVisualization(pipelineData);
                updatePipelineStats(pipelineData);
                
            } catch (error) {
                console.error('Failed to load pipeline status:', error);
                renderErrorPipeline();
            }
        }
        
        function renderPipelineVisualization(pipelineData) {
            const container = document.getElementById('pipelineContainer');
            
            const svg = `
                <svg class="pipeline-svg" viewBox="0 0 800 200">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#667eea" />
                        </marker>
                    </defs>
                    
                    <!-- Kafka Stage -->
                    <g class="pipeline-stage" data-stage="kafka">
                        <rect class="stage-box ${getStageHealthClass(pipelineData.kafkaHealth)}" 
                              x="50" y="60" width="120" height="80" />
                        <text class="stage-text" x="110" y="90">Kafka</text>
                        <text class="stage-count" x="110" y="110">${pipelineData.kafkaEventsReceived.toLocaleString()}</text>
                        ${pipelineData.kafkaErrors > 0 ? `<circle class="error-indicator" cx="160" cy="70" r="10" fill="#dc3545"/>
                        <text x="160" y="75" text-anchor="middle" fill="white" font-size="10">${pipelineData.kafkaErrors}</text>` : ''}
                    </g>
                    
                    <!-- Arrow Kafka -> Pekko -->
                    <line class="pipeline-arrow ${pipelineData.kafkaEventsReceived > 0 ? 'active' : ''}" 
                          x1="170" y1="100" x2="280" y2="100" />
                    
                    <!-- Pekko Stage -->
                    <g class="pipeline-stage" data-stage="pekko">
                        <rect class="stage-box ${getStageHealthClass(pipelineData.pekkoHealth)}" 
                              x="300" y="60" width="120" height="80" />
                        <text class="stage-text" x="360" y="90">Pekko</text>
                        <text class="stage-count" x="360" y="110">${pipelineData.pekkoEventsProcessed.toLocaleString()}</text>
                        ${pipelineData.pekkoErrors > 0 ? `<circle class="error-indicator" cx="410" cy="70" r="10" fill="#dc3545"/>
                        <text x="410" y="75" text-anchor="middle" fill="white" font-size="10">${pipelineData.pekkoErrors}</text>` : ''}
                    </g>
                    
                    <!-- Arrow Pekko -> H2 -->
                    <line class="pipeline-arrow ${pipelineData.pekkoEventsProcessed > 0 ? 'active' : ''}" 
                          x1="420" y1="100" x2="530" y2="100" />
                    
                    <!-- H2 Stage -->
                    <g class="pipeline-stage" data-stage="h2">
                        <rect class="stage-box ${getStageHealthClass(pipelineData.h2Health)}" 
                              x="550" y="60" width="120" height="80" />
                        <text class="stage-text" x="610" y="90">H2 DB</text>
                        <text class="stage-count" x="610" y="110">${pipelineData.h2EventsPersisted.toLocaleString()}</text>
                        ${pipelineData.h2Errors > 0 ? `<circle class="error-indicator" cx="660" cy="70" r="10" fill="#dc3545"/>
                        <text x="660" y="75" text-anchor="middle" fill="white" font-size="10">${pipelineData.h2Errors}</text>` : ''}
                    </g>
                    
                    <!-- Animated particles for active flow -->
                    ${pipelineData.kafkaEventsReceived > 0 ? `
                    <circle class="event-particle flowing" cx="170" cy="100" />
                    <circle class="event-particle flowing" cx="420" cy="100" style="animation-delay: 1s;" />
                    ` : ''}
                    
                    <!-- Pipeline efficiency indicator -->
                    <text x="400" y="30" text-anchor="middle" font-size="14" fill="#667eea" font-weight="bold">
                        Pipeline Efficiency: ${pipelineData.pipelineEfficiency.toFixed(1)}%
                    </text>
                </svg>
            `;
            
            container.innerHTML = svg;
            
            // Add hover tooltips
            addPipelineTooltips(pipelineData);
        }
        
        function getStageHealthClass(stageHealth) {
            if (!stageHealth) return '';
            
            if (stageHealth.isHealthy) {
                return 'healthy';
            } else if (stageHealth.consecutiveFailures >= 10) {
                return 'error';
            } else {
                return 'warning';
            }
        }
        
        function addPipelineTooltips(pipelineData) {
            const stages = document.querySelectorAll('.pipeline-stage');
            
            stages.forEach(stage => {
                const stageName = stage.getAttribute('data-stage');
                let stageData, stageHealth;
                
                switch(stageName) {
                    case 'kafka':
                        stageData = {
                            events: pipelineData.kafkaEventsReceived,
                            errors: pipelineData.kafkaErrors,
                            throughput: pipelineData.kafkaThroughput
                        };
                        stageHealth = pipelineData.kafkaHealth;
                        break;
                    case 'pekko':
                        stageData = {
                            events: pipelineData.pekkoEventsProcessed,
                            errors: pipelineData.pekkoErrors,
                            throughput: pipelineData.pekkoThroughput
                        };
                        stageHealth = pipelineData.pekkoHealth;
                        break;
                    case 'h2':
                        stageData = {
                            events: pipelineData.h2EventsPersisted,
                            errors: pipelineData.h2Errors,
                            throughput: pipelineData.h2Throughput
                        };
                        stageHealth = pipelineData.h2Health;
                        break;
                }
                
                stage.addEventListener('mouseenter', (e) => {
                    showPipelineTooltip(e, stageName, stageData, stageHealth);
                });
                
                stage.addEventListener('mouseleave', hidePipelineTooltip);
            });
        }
        
        function showPipelineTooltip(event, stageName, stageData, stageHealth) {
            const tooltip = document.createElement('div');
            tooltip.className = 'pipeline-tooltip';
            tooltip.innerHTML = `
                <strong>${stageName.toUpperCase()} Stage</strong><br>
                Events: ${stageData.events.toLocaleString()}<br>
                Errors: ${stageData.errors}<br>
                Throughput: ${stageData.throughput.toFixed(1)}/min<br>
                Status: ${stageHealth.isHealthy ? 'Healthy' : 'Issues Detected'}
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            tooltip.style.opacity = '1';
            
            // Store reference for cleanup
            event.target._tooltip = tooltip;
        }
        
        function hidePipelineTooltip(event) {
            if (event.target._tooltip) {
                event.target._tooltip.remove();
                delete event.target._tooltip;
            }
        }
        
        function updatePipelineStats(pipelineData) {
            const container = document.getElementById('pipelineStats');
            
            const totalEvents = pipelineData.kafkaEventsReceived;
            const completedEvents = pipelineData.h2EventsPersisted;
            const totalErrors = pipelineData.kafkaErrors + pipelineData.pekkoErrors + pipelineData.h2Errors;
            const successRate = totalEvents > 0 ? (completedEvents / totalEvents * 100) : 100;
            
            container.innerHTML = `
                <div class="pipeline-stat success">
                    <div class="stat-value">${completedEvents.toLocaleString()}</div>
                    <div class="stat-label">Events Completed</div>
                </div>
                <div class="pipeline-stat ${successRate >= 95 ? 'success' : successRate >= 80 ? 'warning' : 'error'}">
                    <div class="stat-value">${successRate.toFixed(1)}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="pipeline-stat ${totalErrors === 0 ? 'success' : totalErrors < 10 ? 'warning' : 'error'}">
                    <div class="stat-value">${totalErrors}</div>
                    <div class="stat-label">Total Errors</div>
                </div>
                <div class="pipeline-stat ${pipelineData.pipelineEfficiency >= 90 ? 'success' : pipelineData.pipelineEfficiency >= 70 ? 'warning' : 'error'}">
                    <div class="stat-value">${pipelineData.pipelineEfficiency.toFixed(1)}%</div>
                    <div class="stat-label">Pipeline Efficiency</div>
                </div>
                <div class="pipeline-stat">
                    <div class="stat-value">${(pipelineData.kafkaThroughput + pipelineData.pekkoThroughput + pipelineData.h2Throughput / 3).toFixed(1)}</div>
                    <div class="stat-label">Avg Throughput/min</div>
                </div>
                <div class="pipeline-stat">
                    <div class="stat-value">${Math.max(0, totalEvents - completedEvents)}</div>
                    <div class="stat-label">Events In Progress</div>
                </div>
            `;
        }
        
        function renderErrorPipeline() {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc3545;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Pipeline data unavailable</div>
                    </div>
                </div>
            `;
            
            const statsContainer = document.getElementById('pipelineStats');
            statsContainer.innerHTML = `
                <div class="pipeline-stat error">
                    <div class="stat-value">N/A</div>
                    <div class="stat-label">Pipeline Status</div>
                </div>
            `;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>